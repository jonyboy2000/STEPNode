<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
   <TITLE>Using the STEP-NC DLL with COM</TITLE>
   <link rel="stylesheet" type="text/css" href="../pkgcss/style.css">
</HEAD>

<BODY>
<TABLE class=pagehead><TR>
<TD class=logo>Using the STEP-NC DLL with COM</TD>
<TD class=quicklinks>
  <A HREF="http://www.steptools.com">[www.steptools.com]</a>
  <A HREF="../index.html">[STEP-NC Machine]</A>
  <A HREF="index.html">[STEP-NC DLL]</A>
</TD></TR>
</TABLE>
<div class=bktoc>
<FORM class=bksearch method=GET action="http://www.google.com/search">
Search STEP Tools Web Support<br>
<INPUT TYPE=text name=q size=22 maxlength=255 value="">
<INPUT TYPE=hidden name=q value="site:www.steptools.com/support">
<INPUT class=button type=submit name=sa VALUE="Google">
</FORM>

<h3>Hello World Project Files</h3>

<p>This is a Visual Studio 2012 project.  Right-click to save
<ul class=downloads>
<li class=project><A HREF="../demos/stepnc_hello_com.zip">C++ COM Project</A>

</ul>
</div>
<div class=main>
<h2><a name=oview></a>Overview</h2>

<P>The STEP-NC DLL is a .NET API that can be used from C#, Visual
Basic, or C++ through Windows Common Language Infrastructure (CLI)
calls.  The DLL also exports a COM version of API for use with C++
applications that can not use CLI to call the .NET functions.

<P>The COM interface is registered by the STEP-NC Machine installer,
so your program must be run on a machine that has the STEP-NC Machine
package present.

<h2 class=rule><a name=sample></a>Sample Program Using COM</h2>

<P>It is likely that you are using COM because you are adding
functionality to an existing project.  If you are creating a new
project, however, there are no special settings to be aware of.  Any
plain C++ Win32 application will work just fine.

Try it with the <A HREF="../demos/stepnc_hello_com.zip">sample
project</A> containing a COM version of the
<a href="howto_start.html">STEP-NC Hello World example</a>.  The
source code is shown below.

<p>The <b>#import</b> statements at the top of the program bring in
the type library definitions for the core Microsoft classes, and
either the 32bit or 64bit version of the STEP-NC DLL.  The type
library files are located in the STEP-NC Machine install directory.

<p>Further down, the program initializes COM, creates a smart pointer
class, and then makes normal calls.  The smart pointer class
for <a href="AptStepMaker.html">AptStepMaker</a>
is <b>_AptStepMakerPtr</b>, for <a href="Finder.html">Finder</a> it
is <b>_FinderPtr</b>, and for <a href="Tolerance.html">Tolerance</a>
it is <b>_TolerancePtr</b>.  

<PRE class=code>
#include &lt;comutil.h&gt;
#include &lt;stdio.h&gt;

#import &lt;mscorlib.tlb&gt;
#import &lt;System.tlb&gt;

// The namespace and TBL files are different depending on whether you
// are using the 32bit or 64bit version of the library.  The calls are
// otherwise the same.
#ifdef _WIN64
#import "c:\\Program Files (x86)\\STEP Tools\\STEP-NC Machine\\stepnc_x64.tlb" 
#define STEPNC_NAMESPACE stepnc_x64
using namespace stepnc_x64;
#else
#import "c:\\Program Files (x86)\\STEP Tools\\STEP-NC Machine\\stepnc_x86.tlb" 
#define STEPNC_NAMESPACE stepnc_x86
using namespace stepnc_x86;
#endif

using namespace std;

// This example uses the COM Smart pointers, which have an underscore
// prefix and "Ptr" suffix.  You can also do it the old-school way
// using CoCreateInstance
_AptStepMakerPtr oApt;

int main(int argc, char* argv[])
{
    // Initialize COM.
    HRESULT hr = CoInitialize(NULL);

    if (!SUCCEEDED (hr)) {
	printf("Could not initialize COM\n"); 
	return 1;
    }

    // This how smart pointers create the instance
    hr = oApt.CreateInstance(__uuidof(AptStepMaker));
    if (!SUCCEEDED (hr)) {
	printf("Could not initialize Apt instance\n"); 
	return 1;
    }

    // Create a trivial STEP-NC file
    oApt-&gt;PartNo ("test part");
    oApt-&gt;DefineTool (0.25, 5.0, 1.0, 2.0, 3.0, 4.0, 5.0);
    oApt-&gt;LoadTool (1);
    oApt-&gt;Rapid ();
    oApt-&gt;GoToXYZ ("point001", 1.0, 12.0, 0.0);          
    oApt-&gt;GoToXYZ ("point002", 1.0, 14.0, 0.0);
    oApt-&gt;SaveAsModules ("test");

    // Clean up when finished with COM
    CoUninitialize();
    return 0;
}
</PRE>


<h2 class=rule><a name=notes></a>Notes</h2>

<P>The COM interface is automatically registered on install and
unregistered when STEP-NC Machine is uninstalled.  If you manually
ran <b>regasm</b> on an early version, you can clear all COM
registration using <a href="stepnc_com_clear.reg">this .reg file</a>
and then reinstall.

</div>

<div class="copyright">
  Copyright &copy; 2016 STEP Tools Inc. All Rights Reserved.<br>
</div>
</BODY>
</HTML>

